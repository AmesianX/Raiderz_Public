<?xml version="1.0" encoding="UTF-8" ?>
<?xml-stylesheet href="./colt.xsl" type="text/xsl"?>
<maiet>
	<COLT name="Teresis" npcid="620102">
		<COMBAT>
			<DEFAULT>
				<ACTION type="yell" param1="1200" auto_run="true" max_count="1" />
				
				<ACTION type="talent" param1="262010101" rate="40" />
				<ACTION type="talent" param1="262010102" rate="40" />
				
				<ACTION type="talent" param1="262010103" rate="5" />
				<ACTION type="talent" param1="262010104" rate="5" duration="5" />
				<ACTION type="talent" param1="262010113" rate="5" duration="0" />
				<ACTION type="talent" param1="262010114" rate="5" duration="0" />
			</DEFAULT>
			
			<CHECK type="distance" param2="300" >
				<CHECK type="rage" param1="100">
					<ACTION type="talent" param1="262010104" rate="60" duration="0" />
					<ACTION type="talent" param1="262010113" rate="20" duration="0" />
					<ACTION type="talent" param1="262010114" rate="20" duration="0" />
				</CHECK>
			</CHECK>

			<CHECK type="distance" param1="800" >
				<ACTION type="distance" param1="600" param2="600" rate="60"/>
				<ACTION type="talent" param1="262010103" rate="10" />
				<ACTION type="talent" param1="262010107" rate="30" />
			</CHECK>
			
			<CHECK type="hp" param2="60">
				<ACTION type="yell" param1="1200" auto_run="true" max_count="1" />
				
				<ACTION type="talent" param1="262010101" rate="20" />
				<ACTION type="talent" param1="262010102" rate="20" />
				
				<ACTION type="lua" param1="NPC_620102" param2="Healing" rate="20" />
				
				<ACTION type="talent" param1="262010103" rate="5" />
				<ACTION type="talent" param1="262010104" rate="5" />
				<ACTION type="talent" param1="262010113" rate="5" duration="0"/>
				<ACTION type="talent" param1="262010114" rate="5" duration="0"/>
			</CHECK>
		</COMBAT>
		
		<STRESS>
			<CHECK type="stress" param1="300">
				<ACTION type="lua" param1="NPC_620102" param2="Stressed" rate="100" />
			</CHECK>
		</STRESS>
		<IDLE>
			<DEFAULT>
				<ACTION type="nothing" param1="3" rate="50" />
			</DEFAULT>
		</IDLE>
	</COLT>
	<SCRIPT>
	<![CDATA[ 

	--[[
		테레시스
	--]]
	
function NPC_620102:Init(NPCID)
	NPC_ReserveUserData(NPCID, 2);
	
	NPC_620102.LimitForBreakParts	= NPC_620102.MaxHP/15
	
	NPC_620102.TalIdSpiltWeb 		= 262010107
	NPC_620102.TalIdAroundWeb1 		= 262010113
	NPC_620102.TalIdAroundWeb2 		= 262010114
	NPC_620102.TalIdPain1			= 262010112
	NPC_620102.TalIdRoar			= 262010108
	NPC_620102.TalIdHeal			= 262010106
	NPC_620102.TalIdJump			= 262010103
	NPC_620102.TalIdWhirl			= 262010104
	
	NPC_620102.PartIdJawL			= 3
	NPC_620102.PartIdJawR			= 4
end

function NPC_620102:OnBPartRecover()
	for i=1, 2 do
		this:SetUserData( i, 0)
	end -- for
end

function NPC_620102:OnYell(RequestNPC, TargetActor)
	this:Assist(RequestNPC)
end

function NPC_620102:Healing(ThisNPC, Opponent)
	if ThisNPC:IsCooldown( NPC_620102.TalIdHeal ) then
		return
	end
	
	if ThisNPC:GetHP()/ThisNPC:GetMaxHP() == 1 then
		return
	end
	
	if ThisNPC:CheckBPart( NPC_620102.PartIdJawL ) and ThisNPC:CheckBPart( NPC_620102.PartIdJawR ) then
		return
	end
	
	ThisNPC:UseTalentSelf( NPC_620102.TalIdHeal )
end

-- Talent Callback Func
function NPC_620102:OnFinishAndAggroSwap( ThisActor, Enemy )
	local ThisNPC = AsNPC( ThisActor )
	
	ThisNPC:Aggro( "short", 0 )
end

---
function NPC_620102:CheckBreakpart(HitInfo, bFrontPart)
	local ThisNPC = AsNPC( HitInfo.Victim )
	local hpRate = ThisNPC:GetHP()/ThisNPC:GetMaxHP()
	
	
	local currentTalent = ThisNPC:GetCurrentTalent()
	if currentTalent == NPC_620102.TalIdPain1 or currentTalent == NPC_620102.TalIdRoar then
		return HitInfo
	end
	
	if (bFrontPart == true and (ThisNPC:CheckBPart(3) == false or ThisNPC:CheckBPart(4) == false)) then
		-- 전면 누적치
		local frontDamage = ThisNPC:GetUserData(1) + HitInfo.Damage		
		
		if (frontDamage >= NPC_620102.LimitForBreakParts) then
			if (ThisNPC:CheckBPart(3) == false) then
				ThisNPC:ClearJob()
				ThisNPC:BreakPart(3, HitInfo.Attacker)
				ThisNPC:UseTalentSelf( NPC_620102.TalIdPain1 )
				frontDamage = 0
			elseif (ThisNPC:CheckBPart(4) == false) then
				ThisNPC:ClearJob()
				ThisNPC:BreakPart(4, HitInfo.Attacker)
				ThisNPC:UseTalentSelf(NPC_620102.TalIdPain1)
				frontDamage = 0
			end
		end
		
		ThisNPC:SetUserData(1, frontDamage)
	else
		-- 후면 누적치
		local rearDamage = ThisNPC:GetUserData(2) + HitInfo.Damage
		if rearDamage >= NPC_620102.LimitForBreakParts and (ThisNPC:CheckBPart(1) == false or ThisNPC:CheckBPart(2) == false) then
			if (ThisNPC:CheckBPart(1) == false) then
				ThisNPC:ClearJob()
				ThisNPC:BreakPart(1, HitInfo.Attacker)
				ThisNPC:UseTalentSelf(NPC_620102.TalIdPain1)
				rearDamage = 0
			elseif(ThisNPC:CheckBPart(2) == false) then
				ThisNPC:ClearJob()
				ThisNPC:BreakPart(2, HitInfo.Attacker)
				ThisNPC:UseTalentSelf(NPC_620102.TalIdPain1)
				rearDamage = 0
			end
		end
		
		ThisNPC:SetUserData(2, rearDamage)
	end

	return HitInfo
end

function NPC_620102:OnHitCapsule_0_0(HitInfo)
	return NPC_620102:CheckBreakpart(HitInfo, true)
end

function NPC_620102:OnHitCapsule_1_0(HitInfo)
	return NPC_620102:CheckBreakpart(HitInfo, true)
end

function NPC_620102:OnHitCapsule_2_0(HitInfo)
	return NPC_620102:CheckBreakpart(HitInfo, true)
end

function NPC_620102:OnHitCapsule_3_0(HitInfo)
	return NPC_620102:CheckBreakpart(HitInfo, true)
end

function NPC_620102:OnHitCapsule_1_1(HitInfo)
	return NPC_620102:CheckBreakpart(HitInfo, false)
end

-- NPC620101_Stressed
function NPC_620102:Stressed(ThisNPC, Enemy)
	ThisNPC:Aggro("short", 0)

	local Dist = ThisNPC:DistanceTo( Enemy )
	if Dist < 400 and not ThisNPC:IsCooldown( NPC_620102.TalIdWhirl ) then
		
		ThisNPC:UseTalentSelf( NPC_620102.TalIdWhirl )
	end
end
	
	]]>
	</SCRIPT>
</maiet>